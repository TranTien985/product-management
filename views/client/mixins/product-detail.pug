//- mixins/product-detail.pug
mixin product-detail(product, relatedProducts = [])
  .product-detail
    .container
      .product-detail__main
        .product-images
          .main-image
            img#mainImage(src=product.thumbnail, alt=product.title)
          .thumbnail-images
            each thumb, index in product.images || [product.thumbnail]
              .thumbnail(
                class=index === 0 ? 'active' : '',
                data-image=thumb
              )
                img(src=thumb, alt=`${product.title} - Hình ${index + 1}`)

        .product-info
          h1.product-title= product.title
          
          .product-rating
            .stars
              - let stars = Math.round(product.rating || 5)
              - for (let i = 0; i < 5; i++)
                if i < stars
                  | ★
                else
                  | ☆
            .rating-count (#{product.reviewCount || 15} đánh giá)

          .product-price
            if product.priceNew
              span.current-price #{product.priceNew.toLocaleString('vi-VN')}₫
            if product.price
              span.original-price #{product.price.toLocaleString('vi-VN')}₫
            if product.discountPercentage
              span.discount -#{product.discountPercentage}%

          .product-description
            if product.shortDescription
              p= product.shortDescription
            else
              p= product.description

          .product-actions
            .quantity
              button.quantity-btn.minus(type="button") -
              input.quantity-input(type="number", value="1", min="1", max=product.stock || 10)
              button.quantity-btn.plus(type="button") +
            button.add-to-cart(
              type="button",
              data-product-id=product._id || product.id
            ) Thêm vào giỏ hàng
            button.buy-now(
              type="button",
              data-product-id=product._id || product.id
            ) Mua ngay

          .product-meta
            .meta-item
              .meta-label Thương hiệu:
              .meta-value= product.brand || 'Yonex'
            .meta-item
              .meta-label Mã sản phẩm:
              .meta-value= product.sku || product._id
            .meta-item
              .meta-label Tình trạng:
              .meta-value
                if product.stock > 0
                  | Còn hàng
                else
                  | Hết hàng
            .meta-item
              .meta-label Bảo hành:
              .meta-value= product.warranty || '6 tháng'

      //- Product Tabs
      .product-tabs
        .tab-headers
          .tab-header.active(data-tab="description") Mô tả sản phẩm
          .tab-header(data-tab="specs") Thông số kỹ thuật
          .tab-header(data-tab="reviews") Đánh giá

        .tab-content
          #description.tab-pane.active
            if product.fullDescription
              .inner-desc !{product.fullDescription}
            else
              h3= product.title
              p= product.description
              if product.features
                h4 Đặc điểm nổi bật:
                ul
                  each feature in product.features
                    li= feature

          #specs.tab-pane
            table.specs-table
              if product.specifications
                each spec, key in product.specifications
                  tr
                    td= key
                    td= spec
              else
                tr
                  td Thương hiệu
                  td= product.brand || 'Yonex'
                tr
                  td Model
                  td= product.model || product.title
                tr
                  td Màu sắc
                  td= product.color || 'Vàng'
                tr
                  td Trọng lượng
                  td= product.weight || '4U (83g)'
                tr
                  td Cân bằng
                  td= product.balance || 'Head Heavy'

          #reviews.tab-pane
            h3 Đánh giá từ khách hàng
            if product.reviews && product.reviews.length > 0
              each review in product.reviews
                .review
                  .review-header
                    .review-author= review.author
                    .review-rating
                      - for (let i = 0; i < 5; i++)
                        if i < review.rating
                          | ★
                        else
                          | ☆
                    .review-date= review.date
                  .review-content
                    p= review.content
            else
              p Chưa có đánh giá nào cho sản phẩm này.

      //- Related Products
      if relatedProducts.length > 0
        .related-products
          h2.section-title Sản phẩm liên quan
          .products-grid
            each relatedProduct in relatedProducts
              .product-card
                a(href=`/products/${relatedProduct.slug}`)
                  img(
                    src=relatedProduct.thumbnail, 
                    alt=relatedProduct.title
                  )
                  .product-card-body
                    h3.product-card-title= relatedProduct.title
                    .product-card-price
                      if relatedProduct.priceNew
                        | #{relatedProduct.priceNew.toLocaleString('vi-VN')}₫
                      else if relatedProduct.price
                        | #{relatedProduct.price.toLocaleString('vi-VN')}₫

  //- JavaScript for product functionality
  script.
    document.addEventListener('DOMContentLoaded', function() {
      // Thumbnail image switching
      document.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.addEventListener('click', function() {
          document.querySelectorAll('.thumbnail').forEach(t => {
            t.classList.remove('active');
          });
          this.classList.add('active');
          const mainImage = document.getElementById('mainImage');
          mainImage.src = this.getAttribute('data-image');
        });
      });

      // Tab switching
      document.querySelectorAll('.tab-header').forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.tab-header').forEach(t => {
            t.classList.remove('active');
          });
          this.classList.add('active');
          document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active');
          });
          const tabId = this.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');
        });
      });

      // Quantity controls
      const minusBtn = document.querySelector('.minus');
      const plusBtn = document.querySelector('.plus');
      const quantityInput = document.querySelector('.quantity-input');
      
      if (minusBtn && plusBtn && quantityInput) {
        minusBtn.addEventListener('click', function() {
          let currentValue = parseInt(quantityInput.value);
          if (currentValue > 1) {
            quantityInput.value = currentValue - 1;
          }
        });
        
        plusBtn.addEventListener('click', function() {
          let currentValue = parseInt(quantityInput.value);
          const maxStock = parseInt(quantityInput.getAttribute('max')) || 10;
          if (currentValue < maxStock) {
            quantityInput.value = currentValue + 1;
          }
        });
      }

      // Add to cart functionality
      const addToCartBtn = document.querySelector('.add-to-cart');
      if (addToCartBtn) {
        addToCartBtn.addEventListener('click', function() {
          const productId = this.getAttribute('data-product-id');
          const quantity = document.querySelector('.quantity-input').value;
          
          // Gửi request AJAX để thêm vào giỏ hàng
          fetch('/cart/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              productId: productId,
              quantity: parseInt(quantity)
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Sản phẩm đã được thêm vào giỏ hàng!');
              // Cập nhật số lượng trong giỏ hàng trên header
              updateCartCount(data.cartCount);
            } else {
              alert('Có lỗi xảy ra: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi thêm vào giỏ hàng');
          });
        });
      }

      // Buy now functionality
      const buyNowBtn = document.querySelector('.buy-now');
      if (buyNowBtn) {
        buyNowBtn.addEventListener('click', function() {
          const productId = this.getAttribute('data-product-id');
          const quantity = document.querySelector('.quantity-input').value;
          
          // Chuyển hướng đến trang thanh toán
          window.location.href = `/checkout?product=${productId}&quantity=${quantity}`;
        });
      }

      function updateCartCount(count) {
        const cartCountElement = document.querySelector('.cart-count');
        if (cartCountElement) {
          cartCountElement.textContent = count;
        }
      }
   });